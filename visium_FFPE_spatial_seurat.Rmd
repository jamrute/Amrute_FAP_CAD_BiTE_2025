```{r}
library(Seurat)
library(SeuratDisk)
library(ggplot2)
library(patchwork)
library(dplyr)
library(Seurat)
library(ggplot2)
library(patchwork)
library(dplyr)
library(SeuratDisk)
library(ArchR)
library(Matrix)
library(data.table)
library(Seurat)
library(dplyr)
library(gt)
library(igraph)
library(RColorBrewer)
library(compositions)
library(harmony)
library(compositions)
library(tidyverse)
library(clustree)
library(uwot)
library(scran)
library(cluster)
```

# Selecting cells
```{r}
s6 <- Load10X_Spatial(data.dir = "../data/Visium_T1099R", slice = "Visium_T1099R")
#kept.genes <- rownames(s6@assays$Spatial)[ Matrix::rowSums(s6) >= 3]
#s6[["Spatial"]] <- CreateAssayObject(counts = s6[["Spatial"]]@counts[kept.genes , ] )
s6$sample <- "Visium_T1099R"
s6$category <- "Mild"
spot_composition <- read.csv("../tangram/output/Visium_T1099R/Visium_T1099R.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s6$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s6@assays[["SpotComposition"]] <- spot_composition_assay
s6@assays$SpotComposition@key <- "spotcomposition_"
s6 <- subset(s6, subset = nCount_Spatial > 0)
#s6 <- subset(s6, cells = colnames(s6_keep))
s6 <- SCTransform(s6, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")
DefaultAssay(s6) <- "SCT"
s6 <- RunPCA(s6, assay = "SCT", verbose = FALSE)
s6 <- FindNeighbors(s6, reduction = "pca", dims = 1:30)
s6 <- FindClusters(s6, verbose = FALSE, resolution = c(0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9))
s6 <- RunUMAP(s6, reduction = "pca", dims = 1:30)
DimPlot(s6, reduction = "umap", group.by = c("SCT_snn_res.0.5"), cols = paletteDiscrete(unique(s6$SCT_snn_res.0.5), set = "stallion"), ncol = 1)
Idents(s6) <- "SCT_snn_res.0.5"
SpatialDimPlot(s6, cols = paletteDiscrete(unique(s6$SCT_snn_res.0.5), set = "stallion"))
```

```{r}
SpatialDimPlot(s6, cols = paletteDiscrete(unique(s6$SCT_snn_res.0.5), set = "stallion"))
```

```{r}
df <- s6@images[["Visium_T1099R"]]@coordinates
df$cluster <- as.character(s6$SCT_snn_res.0.5)
x1 <- CellSelector(df %>%  ggplot(aes(x = imagerow, y = imagecol, color = cluster)) + geom_point())
s6 <- subset(s6, cells = x1, invert = TRUE)
```

```{r}
s6_keep <- s6
```

```{r}
s1 <- Load10X_Spatial(data.dir = "../data/Visium_D1118_LAD", slice = "Visium_D1118_LAD")
#kept.genes <- rownames(s1@assays$Spatial)[ Matrix::rowSums(s1) >= 3]
#s1[["Spatial"]] <- CreateAssayObject(counts = s1[["Spatial"]]@counts[kept.genes , ] )
s1$sample <- "Visium_D1118_LAD"
s1$category <- "Severe"
spot_composition <- read.csv("../tangram/output/Visium_D1118_LAD/Visium_D1118_LAD.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s1$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s1@assays[["SpotComposition"]] <- spot_composition_assay
s1@assays$SpotComposition@key <- "spotcomposition_"
s1 <- subset(s1, subset = nCount_Spatial > 0)
s1 <- SCTransform(s1, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

s2 <- Load10X_Spatial(data.dir = "../data/Visium_LCA", slice = "Visium_LCA")
#kept.genes <- rownames(s2@assays$Spatial)[ Matrix::rowSums(s2) >= 3]
#s2[["Spatial"]] <- CreateAssayObject(counts = s2[["Spatial"]]@counts[kept.genes , ] )
s2$sample <- "Visium_LCA"
s2$category <- "Severe"
spot_composition <- read.csv("../tangram/output/Visium_LCA/Visium_LCA.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s2$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s2@assays[["SpotComposition"]] <- spot_composition_assay
s2@assays$SpotComposition@key <- "spotcomposition_"
s2 <- subset(s2, subset = nCount_Spatial > 0)
s2 <- SCTransform(s2, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

s3 <- Load10X_Spatial(data.dir = "../data/Visium_T1071", slice = "Visium_T1071")
#kept.genes <- rownames(s3@assays$Spatial)[ Matrix::rowSums(s3) >= 3]
#s3[["Spatial"]] <- CreateAssayObject(counts = s3[["Spatial"]]@counts[kept.genes , ] )
s3$sample <- "Visium_T1071"
s3$category <- "Severe"
spot_composition <- read.csv("../tangram/output/Visium_T1071/Visium_T1071.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s3$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s3@assays[["SpotComposition"]] <- spot_composition_assay
s3@assays$SpotComposition@key <- "spotcomposition_"
s3 <- subset(s3, subset = nCount_Spatial > 0)
s3 <- SCTransform(s3, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

s4 <- Load10X_Spatial(data.dir = "../data/Visium_T1077", slice = "Visium_T1077")
#kept.genes <- rownames(s4@assays$Spatial)[ Matrix::rowSums(s4) >= 3]
#s4[["Spatial"]] <- CreateAssayObject(counts = s4[["Spatial"]]@counts[kept.genes , ] )
s4$sample <- "Visium_T1077"
s4$category <- "Moderate"
spot_composition <- read.csv("../tangram/output/Visium_T1077/Visium_T1077.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s4$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s4@assays[["SpotComposition"]] <- spot_composition_assay
s4@assays$SpotComposition@key <- "spotcomposition_"
s4 <- subset(s4, subset = nCount_Spatial > 0)
s4 <- SCTransform(s4, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

s5 <- Load10X_Spatial(data.dir = "../data/Visium_T1079", slice = "Visium_T1079")
#kept.genes <- rownames(s5@assays$Spatial)[ Matrix::rowSums(s5) >= 3]
#s5[["Spatial"]] <- CreateAssayObject(counts = s5[["Spatial"]]@counts[kept.genes , ] )
s5$sample <- "Visium_T1079"
s5$category <- "Moderate"
spot_composition <- read.csv("../tangram/output/Visium_T1079/Visium_T1079.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s5$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s5@assays[["SpotComposition"]] <- spot_composition_assay
s5@assays$SpotComposition@key <- "spotcomposition_"
s5 <- subset(s5, subset = nCount_Spatial > 0)
s5 <- SCTransform(s5, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

#s6 <- Load10X_Spatial(data.dir = "../data/Visium_T1099R", slice = "Visium_T1099R")
##kept.genes <- rownames(s6@assays$Spatial)[ Matrix::rowSums(s6) >= 3]
##s6[["Spatial"]] <- CreateAssayObject(counts = s6[["Spatial"]]@counts[kept.genes , ] )
#s6$sample <- "Visium_T1099R"
#s6$category <- "Mild"
#spot_composition <- read.csv("../tangram/output/Visium_T1099R/Visium_T1099R.csv")
#spot_composition2 <- spot_composition[,-1]
#rownames(spot_composition2) <- spot_composition[,1]
#s6$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
#spot_composition2 <- t(spot_composition2)
#spot_composition_assay <- CreateAssayObject(spot_composition2)
#s6@assays[["SpotComposition"]] <- spot_composition_assay
#s6@assays$SpotComposition@key <- "spotcomposition_"
#s6 <- subset(s6, subset = nCount_Spatial > 0)
#s6 <- subset(s6, cells = colnames(s6_keep))
#s6 <- SCTransform(s6, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

s7 <- Load10X_Spatial(data.dir = "../data/Visium_T1111", slice = "Visium_T1111")
#kept.genes <- rownames(s7@assays$Spatial)[ Matrix::rowSums(s7) >= 3]
#s7[["Spatial"]] <- CreateAssayObject(counts = s7[["Spatial"]]@counts[kept.genes , ] )
s7$sample <- "Visium_T1111"
s7$category <- "Severe"
spot_composition <- read.csv("../tangram/output/Visium_T1111/Visium_T1111.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s7$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s7@assays[["SpotComposition"]] <- spot_composition_assay
s7@assays$SpotComposition@key <- "spotcomposition_"
s7 <- subset(s7, subset = nCount_Spatial > 0)
s7 <- SCTransform(s7, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

s8 <- Load10X_Spatial(data.dir = "../data/Visium_T1153R", slice = "Visium_T1153R")
#kept.genes <- rownames(s8@assays$Spatial)[ Matrix::rowSums(s8) >= 3]
#s8[["Spatial"]] <- CreateAssayObject(counts = s8[["Spatial"]]@counts[kept.genes , ] )
s8$sample <- "Visium_T1153R"
s8$category <- "Moderate"
spot_composition <- read.csv("../tangram/output/Visium_T1153R/Visium_T1153R.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s8$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s8@assays[["SpotComposition"]] <- spot_composition_assay
s8@assays$SpotComposition@key <- "spotcomposition_"
s8 <- subset(s8, subset = nCount_Spatial > 0)
s8 <- SCTransform(s8, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

s9 <- Load10X_Spatial(data.dir = "../data/Visium_T1161_RCA", slice = "Visium_T1161_RCA")
#kept.genes <- rownames(s9@assays$Spatial)[ Matrix::rowSums(s9) >= 3]
#s9[["Spatial"]] <- CreateAssayObject(counts = s9[["Spatial"]]@counts[kept.genes , ] )
s9$sample <- "Visium_T1161_RCA"
s9$category <- "Moderate"
spot_composition <- read.csv("../tangram/output/Visium_T1161_RCA/Visium_T1161_RCA.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s9$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s9@assays[["SpotComposition"]] <- spot_composition_assay
s9@assays$SpotComposition@key <- "spotcomposition_"
s9 <- subset(s9, subset = nCount_Spatial > 0)
s9 <- SCTransform(s9, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

s10 <- Load10X_Spatial(data.dir = "../data/Visium_T1163", slice = "Visium_T1163")
#kept.genes <- rownames(s10@assays$Spatial)[ Matrix::rowSums(s10) >= 3]
#s10[["Spatial"]] <- CreateAssayObject(counts = s10[["Spatial"]]@counts[kept.genes , ] )
s10 <- subset(s10, subset = nCount_Spatial > 0)
s10 <- SCTransform(s10, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")
s10$sample <- "Visium_T1163"
s10$category <- "Moderate"
spot_composition <- read.csv("../tangram/output/Visium_T1163/Visium_T1163.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s10$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s10@assays[["SpotComposition"]] <- spot_composition_assay
s10@assays$SpotComposition@key <- "spotcomposition_"
s10 <- subset(s10, subset = nCount_Spatial > 0)
s10 <- SCTransform(s10, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

s11 <- Load10X_Spatial(data.dir = "../data/Visium_T1167_LAD", slice = "Visium_T1167_LAD")
#kept.genes <- rownames(s11@assays$Spatial)[ Matrix::rowSums(s11) >= 3]
#s11[["Spatial"]] <- CreateAssayObject(counts = s11[["Spatial"]]@counts[kept.genes , ] )
s11 <- subset(s11, subset = nCount_Spatial > 0)
s11 <- SCTransform(s11, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")
s11$sample <- "Visium_T1167_LAD"
s11$category <- "Severe"
spot_composition <- read.csv("../tangram/output/Visium_T1167_LAD/Visium_T1167_LAD.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s11$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s11@assays[["SpotComposition"]] <- spot_composition_assay
s11@assays$SpotComposition@key <- "spotcomposition_"
s11 <- subset(s11, subset = nCount_Spatial > 0)
s11 <- SCTransform(s11, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

s12 <- Load10X_Spatial(data.dir = "../data/Visium_T1170_LAD", slice = "Visium_T1170_LAD")
#kept.genes <- rownames(s12@assays$Spatial)[ Matrix::rowSums(s12) >= 3]
#s12[["Spatial"]] <- CreateAssayObject(counts = s12[["Spatial"]]@counts[kept.genes , ] )
s12$sample <- "Visium_T1170_LAD"
s12$category <- "Mild"
spot_composition <- read.csv("../tangram/output/Visium_T1170_LAD/Visium_T1170_LAD.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s12$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s12@assays[["SpotComposition"]] <- spot_composition_assay
s12@assays$SpotComposition@key <- "spotcomposition_"
s12 <- subset(s12, subset = nCount_Spatial > 0)
s12 <- SCTransform(s12, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

s13 <- Load10X_Spatial(data.dir = "../data/Visium_T1171_LM", slice = "Visium_T1171_LM")
#kept.genes <- rownames(s13@assays$Spatial)[ Matrix::rowSums(s13) >= 3]
#s13[["Spatial"]] <- CreateAssayObject(counts = s13[["Spatial"]]@counts[kept.genes , ] )
s13$sample <- "Visium_T1171_LM"
s13$category <- "Mild"
spot_composition <- read.csv("../tangram/output/Visium_T1171_LM/Visium_T1171_LM.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s13$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s13@assays[["SpotComposition"]] <- spot_composition_assay
s13@assays$SpotComposition@key <- "spotcomposition_"
s13 <- subset(s13, subset = nCount_Spatial > 0)
s13 <- SCTransform(s13, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

s14 <- Load10X_Spatial(data.dir = "../data/Visium_T1183_RCA", slice = "Visium_T1183_RCA")
#kept.genes <- rownames(s14@assays$Spatial)[ Matrix::rowSums(s14) >= 3]
#s14[["Spatial"]] <- CreateAssayObject(counts = s14[["Spatial"]]@counts[kept.genes , ] )
s14$sample <- "Visium_T1183_RCA"
s14$category <- "Moderate"
spot_composition <- read.csv("../tangram/output/Visium_T1183_RCA/Visium_T1183_RCA.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s14$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s14@assays[["SpotComposition"]] <- spot_composition_assay
s14@assays$SpotComposition@key <- "spotcomposition_"
s14 <- subset(s14, subset = nCount_Spatial > 0)
s14 <- SCTransform(s14, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

s15 <- Load10X_Spatial(data.dir = "../data/Visium_T1186_RCA", slice = "Visium_T1186_RCA")
#kept.genes <- rownames(s15@assays$Spatial)[ Matrix::rowSums(s15) >= 3]
#s15[["Spatial"]] <- CreateAssayObject(counts = s15[["Spatial"]]@counts[kept.genes , ] )
s15$sample <- "Visium_T1186_RCA"
s15$category <- "Mild"
spot_composition <- read.csv("../tangram/output/Visium_T1186_RCA/Visium_T1186_RCA.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s15$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s15@assays[["SpotComposition"]] <- spot_composition_assay
s15@assays$SpotComposition@key <- "spotcomposition_"
s15 <- subset(s15, subset = nCount_Spatial > 0)
s15 <- SCTransform(s15, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")

s16 <- Load10X_Spatial(data.dir = "../data/Visium_T1190_RCA", slice = "Visium_T1190_RCA")
#kept.genes <- rownames(s16@assays$Spatial)[ Matrix::rowSums(s16) >= 3]
#s16[["Spatial"]] <- CreateAssayObject(counts = s16[["Spatial"]]@counts[kept.genes , ] )
s16$sample <- "Visium_T1190_RCA"
s16$category <- "Moderate"
spot_composition <- read.csv("../tangram/output/Visium_T1190_RCA/Visium_T1190_RCA.csv")
spot_composition2 <- spot_composition[,-1]
rownames(spot_composition2) <- spot_composition[,1]
s16$cell.type.max <- apply(spot_composition2, 1, function(x) paste0(names(spot_composition2)[x == max(x)],collapse = '_'))
spot_composition2 <- t(spot_composition2)
spot_composition_assay <- CreateAssayObject(spot_composition2)
s16@assays[["SpotComposition"]] <- spot_composition_assay
s16@assays$SpotComposition@key <- "spotcomposition_"
s16 <- subset(s16, subset = nCount_Spatial > 0)
s16 <- SCTransform(s16, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")
```

```{r}
merged <- merge(s1, y = c(s2, s3, s4, s5, s6_keep, s7, s8, s9, s10, s11, s12, s13, s14, s15, s16))
saveRDS(merged, "merged.rds")
```

```{r}
merged <- readRDS("cad_spatial_integrated.rds")
```


# RNA
```{r}
DefaultAssay(merged) <- "SCT"
VariableFeatures(merged) <- c(VariableFeatures(s1), VariableFeatures(s2), VariableFeatures(s3), VariableFeatures(s4), VariableFeatures(s5),
                              VariableFeatures(s6_keep), VariableFeatures(s7), VariableFeatures(s8), VariableFeatures(s9), VariableFeatures(s10),
                              VariableFeatures(s11), VariableFeatures(s12), VariableFeatures(s13), VariableFeatures(s14), VariableFeatures(s15),
                              VariableFeatures(s16))
merged <- RunPCA(merged, assay = "SCT", verbose = FALSE)
merged <- FindNeighbors(merged, reduction = "pca", dims = 1:50)
merged <- FindClusters(merged, verbose = FALSE, resolution = c(0.1,0.2,0.3,0.4,0.5))
merged <- RunUMAP(merged, reduction = "pca", dims = 1:50)
```

```{r}
DimPlot(merged, reduction = "umap", group.by = c("SCT_snn_res.0.3"), cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"), split.by = "category")
```

```{r}
DimPlot(merged, reduction = "umap", group.by = c("SCT_snn_res.0.3"), cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"),ncol = 2)
```

```{r}
Idents(merged) <- "SCT_snn_res.0.3"

SpatialDimPlot(merged, images = "Visium_T1170_LAD", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_T1170_LAD-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_T1186_RCA", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_T1186_RCA-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_T1171_LM", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_T1171_LM-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_T1099R", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_T1099R-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_T1077", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_T1077-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_T1163", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_T1163-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_T1183_RCA", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_T1183_RCA-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_T1153R", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_T1153R-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_T1161_RCA", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_T1161_RCA-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_T1190_RCA", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_T1190_RCA-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_T1079", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_T1079-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_LCA", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_LCA-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_D1118_LAD", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_D1118_LAD-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_T1071", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_T1071-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_T1111", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_T1111-SCT_snn_res.0.3.png")

SpatialDimPlot(merged, images = "Visium_T1167_LAD", cols = paletteDiscrete(unique(merged$SCT_snn_res.0.3), set = "stallion"))
ggsave("Visium_T1167_LAD-SCT_snn_res.0.3.png")

```

```{r}
merged <- PrepSCTFindMarkers(merged, assay = "SCT", verbose = TRUE)
```

```{r}
DefaultAssay(merged) <- 'SCT'
Idents(merged) <- "SCT_snn_res.0.3"
rna.rnamarkers <- FindAllMarkers(merged, only.pos = TRUE, min.pct = 0.1, logfc.threshold = 0.1)
write.csv(rna.rnamarkers, file ="./DE_SCT_snn_res.0.3.csv", quote = FALSE)
```

# Spatially Variable Genes
```{r}
merged <- FindSpatiallyVariableFeatures(merged, assay = "SCT", features = VariableFeatures(merged)[1:3000], selection.method = "moransi")
```

```{r}
top.features <- head(SpatiallyVariableFeatures(merged, selection.method = "moransi"), 6)
```

```{r}
unique(merged$sample)
```

```{r}
SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_D1118_LAD")
ggsave("Visium_D1118_LAD-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_LCA")
ggsave("Visium_LCA-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_T1071")
ggsave("Visium_T1071-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_T1077")
ggsave("Visium_T1077-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_T1079")
ggsave("Visium_T1079-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_T1099R")
ggsave("Visium_T1099R-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_T1111")
ggsave("Visium_T1111-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_T1153R")
ggsave("Visium_T1153R-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_T1161_RCA")
ggsave("Visium_T1161_RCA-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_T1163")
ggsave("Visium_T1163-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_T1167_LAD")
ggsave("Visium_T1167_LAD-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_T1170_LAD")
ggsave("Visium_T1170_LAD-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_T1171_LM")
ggsave("Visium_T1171_LM-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_T1183_RCA")
ggsave("Visium_T1183_RCA-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_T1186_RCA")
ggsave("Visium_T1186_RCA-Top6_SVG.png")

SpatialFeaturePlot(merged, features = top.features, ncol = 3, images = "Visium_T1190_RCA")
ggsave("Visium_T1190_RCA-Top6_SVG.png")
```

# Progeny
```{r}
Idents(merged) <- "SCT_snn_res.0.3"
```

```{r}
## We create a data frame with the specification of the cells that belong to 
## each cluster to match with the Progeny scores.
CellsClusters <- data.frame(Cell = names(Idents(merged)), 
    CellType = as.character(Idents(merged)),
    stringsAsFactors = FALSE)
```

```{r}
## We compute the Progeny activity scores and add them to our Seurat object
## as a new assay called Progeny. 
merged <- progeny(merged, scale=FALSE, organism="Human", top=500, perm=1, 
    return_assay = TRUE, assay_name = "SCT")

## We can now directly apply Seurat functions in our Progeny scores. 
## For instance, we scale the pathway activity scores. 
merged <- Seurat::ScaleData(merged, assay = "progeny") 

## We transform Progeny scores into a data frame to better handling the results
progeny_scores_df <- 
    as.data.frame(t(GetAssayData(merged, slot = "scale.data", 
        assay = "progeny"))) %>%
    rownames_to_column("Cell") %>%
    gather(Pathway, Activity, -Cell) 

## We match Progeny scores with the cell clusters.
progeny_scores_df <- inner_join(progeny_scores_df, CellsClusters)

## We summarize the Progeny scores by cellpopulation
summarized_progeny_scores <- progeny_scores_df %>% 
    group_by(Pathway, CellType) %>%
    summarise(avg = mean(Activity), std = sd(Activity))
```

# NFkB
```{r}
DefaultAssay(merged) <- "progeny"
FeaturePlot(object=merged, features = "NFkB",pt.size=.5, reduction = 'umap', ncol = 2) + scale_color_gradientn(colors=paletteContinuous("blueYellow"), oob=scales::squish, limits=c(15,50)) + NoLegend()
```

# TGFb
```{r}
DefaultAssay(merged) <- "progeny"
FeaturePlot(object=merged, features = "TGFb",pt.size=.5, reduction = 'umap', ncol = 2) + scale_color_gradientn(colors=paletteContinuous("blueYellow"), oob=scales::squish, limits=c(25,50)) + NoLegend()
```

```{r}
images <- unique(merged$sample)

for (im in images) {
  SpatialFeaturePlot(merged, features = c("NFkB"), ncol = 3, images = im) + scale_fill_gradientn(colors=paletteContinuous("blueYellow"), oob=scales::squish, limits=c(25,50))
  ggsave(paste0("./progeny/", im, "-NFkB-Top6_SVG.png"))
  
    SpatialFeaturePlot(merged, features = c("TGFb"), ncol = 3, images = im) + scale_fill_gradientn(colors=paletteContinuous("blueYellow"), oob=scales::squish, limits=c(25,50))
  ggsave(paste0("./progeny/", im, "-TGFb-Top6_SVG.png"))
}
```

# Whole dataset: Correlation matrix
```{r}
library(pheatmap)
library(corrplot)

df <- t(as.data.frame(merged@assays$SpotComposition@counts))
df <- df[,c('Fibroblast1','Myeloid','Endothelium','SMCPericyte','ModSMC','Fibroblast2','TCells','BCells')]

corr_mat <- cor(df)

pheatmap(corr_mat, scale="none", cluster_rows=FALSE, fontsize_row=8, fontsize_col=8, cluster_cols = FALSE, legend = TRUE, cellwidth = 16, cellheight = 16, border_color=NA)

diag(corr_mat) <- 0

testRes = cor.mtest(df, conf.level = 0.95)

corrplot(corr_mat,
         title = "\n\n\n",
         is.corr = FALSE, ## changed this line
         order = "hclust",
#         col.lim = c(-1,1), 
         diag = FALSE,
         method = 'color',
         pch.col = 'grey20',
         addrect = 3, rect.col = 'black', rect.lwd = 3)
```

```{r}
avg <- AverageExpression(merged, assay = "SpotComposition", group.by = "SCT_snn_res.0.3")
```

```{r}
pheatmap(as.matrix(avg$SpotComposition), scale="row", cluster_rows=TRUE, fontsize_row=8, fontsize_col=8, cluster_cols = TRUE, legend = TRUE, cellwidth = 16, cellheight = 16, border_color=NA, col=viridis(240), breaks = seq(0, 1, by = 1/240))
```

```{r}
merged <- readRDS("cad_spatial_integrated.rds")
```

```{r}
library(remotes)
#remotes::install_github("carmonalab/GeneNMF") #from Github
library(GeneNMF)
library(Seurat)
library(ggplot2)
library(UCell)
library(patchwork)
library(Matrix)
library(RcppML)
library(viridis)
```

```{r}
library(scCustomize)
merged <- SCTransform(merged, assay = "Spatial", verbose = FALSE, vars.to.regress = "nCount_Spatial")
```

```{r}
seu <- merged
```

```{r}
ndim <- 30

seu <- FindVariableFeatures(seu, nfeatures = 3000)
seu <- runNMF(seu, k = ndim, assay="SCT")
```

```{r}
seu <- RunUMAP(seu, reduction = "NMF", dims=1:ndim, reduction.name = "NMF_UMAP", reduction.key = "nmfUMAP_")
```

```{r}
DimPlot(seu, reduction = "umap", group.by = c("SCT_snn_res.0.3"), cols = paletteDiscrete(unique(seu$SCT_snn_res.0.3), set = "stallion"),ncol = 2)
```

```{r}
seu <- FindNeighbors(seu, reduction = "NMF", dims = 1:30, graph.name = "NMF_NN")
seu <- FindClusters(seu, verbose = FALSE, resolution = c(0.1,0.2,0.3,0.4,0.5), graph.name = "NMF_NN")
seu <- RunUMAP(seu, reduction = "NMF", dims = 1:30)
```

```{r}
DimPlot(seu, reduction = "NMF_UMAP", group.by = c("NMF_NN_res.0.5"), cols = paletteDiscrete(unique(seu$NMF_NN_res.0.5), set = "stallion"),ncol = 2)
```

```{r}
DefaultAssay(seu) <- 'SCT'
Idents(seu) <- "SCT_snn_res.0.3"
rna.rnamarkers <- FindAllMarkers(seu, only.pos = TRUE, min.pct = 0.1, logfc.threshold = 0.1)
write.csv(rna.rnamarkers, file ="./DE_NMF_NN_res.0.5.csv", quote = FALSE)
```

```{r}
seu.list <- SplitObject(seu, split.by = "sample")
geneNMF.programs <- multiNMF(seu.list, assay="SCT", slot="data", k=4:9, nfeatures = 3000)
```

```{r}
geneNMF.metaprograms <- getMetaPrograms(geneNMF.programs,
                                        nMP=10,
                                        weight.explained = 0.7,
                                        max.genes=100)
```

```{r}
plotMetaPrograms(geneNMF.metaprograms)
```

```{r}
geneNMF.metaprograms$metaprograms.metrics
```

```{r}
lapply(geneNMF.metaprograms$metaprograms.genes, head)
```

```{r}
MP1_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP1)
MP1_genes$MP <- "MP1"
colnames(MP1_genes) <- c("gene","MP")

MP2_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP2)
MP2_genes$MP <- "MP2"
colnames(MP2_genes) <- c("gene","MP")

MP3_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP3)
MP3_genes$MP <- "MP3"
colnames(MP3_genes) <- c("gene","MP")

MP4_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP4)
MP4_genes$MP <- "MP4"
colnames(MP4_genes) <- c("gene","MP")

MP5_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP5)
MP5_genes$MP <- "MP5"
colnames(MP5_genes) <- c("gene","MP")

MP6_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP6)
MP6_genes$MP <- "MP6"
colnames(MP6_genes) <- c("gene","MP")

MP7_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP7)
MP7_genes$MP <- "MP7"
colnames(MP7_genes) <- c("gene","MP")

MP8_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP8)
MP8_genes$MP <- "MP8"
colnames(MP8_genes) <- c("gene","MP")

MP9_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP9)
MP9_genes$MP <- "MP9"
colnames(MP9_genes) <- c("gene","MP")

MP10_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP10)
MP10_genes$MP <- "MP10"
colnames(MP10_genes) <- c("gene","MP")
```

```{r}
MP_genes <- bind_rows(MP1_genes, MP2_genes, MP3_genes, MP4_genes, MP5_genes, MP6_genes, MP7_genes, MP8_genes, MP9_genes, MP10_genes)
```

```{r}
GWAS <- read_delim("./CAD_GWAS_genes.csv", ",", escape_double = FALSE, trim_ws = TRUE)
gwas_genes <- list(GWAS$gene)[[1]]
gwas_genes
```

```{r}
intersecting_genes <- Reduce(intersect, list(MP_genes$gene, gwas_genes))
length(intersecting_genes)
```

```{r}
DGE_subset <- filter(MP_genes, MP_genes$gene %in% intersecting_genes)
DGE_subset
```

```{r}
cad_gwas_overlap <- data.frame(sort(table(DGE_subset$MP), decreasing=T))
cad_gwas_overlap
```

```{r}
pdf("./cad_gwas_overlap_MP_VisiumFFPE.pdf", useDingbats = FALSE, width=3.5, height=2.5)
cad_gwas_overlap$Var1 <- factor(cad_gwas_overlap$Var1, levels = c("MP10", "MP8", "MP7","MP6", "MP3","MP1","MP2","MP5","MP4"))
ggplot(cad_gwas_overlap, aes(x=Var1, y=Freq)) +
    geom_segment( aes(xend=Var1, yend=0.5)) +
    geom_point( size=2, color="black") +
    coord_flip() +
    theme_bw() +
    xlab("")
dev.off()
```


```{r}
library(msigdbr)
library(fgsea)
```

```{r}
top_p <- lapply(geneNMF.metaprograms$metaprograms.genes, function(program) {
  runGSEA(program, universe=rownames(seu), category = "H")
})
```

```{r}
head(top_p$MP4)
```
```{r}
mp.genes <- geneNMF.metaprograms$metaprograms.genes
seu <- AddModuleScore_UCell(seu, features = mp.genes, assay="SCT", name = "")
```

```{r}
matrix <- seu@meta.data[,names(mp.genes)]

#dimred <- scale(matrix)
dimred <- as.matrix(matrix)

colnames(dimred) <- paste0("MP_",seq(1, ncol(dimred)))
#New dim reduction
seu@reductions[["MPsignatures"]] <- new("DimReduc",
                                         cell.embeddings = dimred,
                                         assay.used = "Spatial",
                                         key = "MP_",
                                         global = FALSE)
```

```{r}
set.seed(123)
seu <- RunUMAP(seu, reduction="MPsignatures", dims=1:length(seu@reductions[["MPsignatures"]]),
               metric = "euclidean", reduction.name = "umap_MP")
```

```{r}
seu <- FindNeighbors(seu, reduction = "MPsignatures", dims=1:length(seu@reductions[["MPsignatures"]]), graph.name = "MPsignatures_NN")
seu <- FindClusters(seu, verbose = FALSE, resolution = c(0.1,0.2,0.3,0.4,0.5), graph.name = "MPsignatures_NN")
```

```{r}
DimPlot(seu, reduction = "umap_MP", group.by = c("MPsignatures_NN_res.0.5"), cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"),ncol = 2)
```
```{r}
FeaturePlot(seu, features = "MP4", reduction = "umap_MP") &
  scale_color_viridis(option="B") &
   theme(aspect.ratio = 1, axis.text=element_blank(), axis.ticks=element_blank())
```


```{r}
FeaturePlot(seu, features = names(mp.genes), reduction = "umap_MP", ncol=5) &
  scale_color_viridis(option="B") &
   theme(aspect.ratio = 1, axis.text=element_blank(), axis.ticks=element_blank())
```

```{r}
FeaturePlot(seu, features = names(mp.genes), reduction = "NMF_UMAP", ncol=5) &
  scale_color_viridis(option="B") &
   theme(aspect.ratio = 1, axis.text=element_blank(), axis.ticks=element_blank())
```

```{r}
SpatialFeaturePlot(object=seu, features = "MP1", images = "Visium_T1071") + scale_fill_gradientn(colors=viridis::inferno(256))
SpatialFeaturePlot(object=seu, features = "MP2", images = "Visium_T1071") + scale_fill_gradientn(colors=viridis::inferno(256))
SpatialFeaturePlot(object=seu, features = "MP3", images = "Visium_T1071") + scale_fill_gradientn(colors=viridis::inferno(256))
SpatialFeaturePlot(object=seu, features = "MP4", images = "Visium_T1071") + scale_fill_gradientn(colors=viridis::inferno(256))
SpatialFeaturePlot(object=seu, features = "MP5", images = "Visium_T1071") + scale_fill_gradientn(colors=viridis::inferno(256))
SpatialFeaturePlot(object=seu, features = "MP6", images = "Visium_T1071") + scale_fill_gradientn(colors=viridis::inferno(256))
SpatialFeaturePlot(object=seu, features = "MP7", images = "Visium_T1071") + scale_fill_gradientn(colors=viridis::inferno(256))
SpatialFeaturePlot(object=seu, features = "MP8", images = "Visium_T1071") + scale_fill_gradientn(colors=viridis::inferno(256))
SpatialFeaturePlot(object=seu, features = "MP9", images = "Visium_T1071") + scale_fill_gradientn(colors=viridis::inferno(256))
SpatialFeaturePlot(object=seu, features = "MP10", images = "Visium_T1071") + scale_fill_gradientn(colors=viridis::inferno(256))
```

# MP by cell type
```{r}
MP_celltype <- seu@meta.data[,c("cell.type.max","MP1","MP2","MP3","MP4","MP5","MP6","MP7","MP8","MP9","MP10")]
```

```{r}
library(dplyr)
MP_celltype_avg <- MP_celltype %>%
    group_by(cell.type.max) %>% 
    summarise_each(funs(mean))
```

```{r}
MP_celltype_avg2 <- MP_celltype_avg[,-1]
MP_celltype_avg2 <- as.data.frame(MP_celltype_avg2)
rownames(MP_celltype_avg2) <- MP_celltype_avg$cell.type.max
MP_celltype_avg2
```
```{r}
MP_celltype_avg2 <- MP_celltype_avg2[c("BCells","Endothelium","Fibroblast1","Fibroblast2","ModSMC","Myeloid","SMCPericyte","TCells"),]
```

```{r}
pdf("./MP_celltype.pdf", useDingbats = FALSE, width=3.5, height=2.5)
library(pheatmap)
pheatmap(MP_celltype_avg2, scale="column", col=paletteContinuous("solarExtra"), cluster_rows=TRUE, fontsize_row=10, fontsize_col=10, cluster_cols = TRUE, legend = TRUE, border_color=NA)
dev.off()
```

# MP by condition
```{r}
MP_celltype <- seu@meta.data[,c("category","MP1","MP2","MP3","MP4","MP5","MP6","MP7","MP8","MP9","MP10")]
```

```{r}
library(dplyr)
MP_celltype_avg <- MP_celltype %>%
    group_by(category) %>% 
    summarise_each(funs(mean))
```

```{r}
MP_celltype_avg2 <- MP_celltype_avg[,-1]
MP_celltype_avg2 <- as.data.frame(MP_celltype_avg2)
rownames(MP_celltype_avg2) <- MP_celltype_avg$category
MP_celltype_avg2
```

```{r}
pdf("./MP_severity.pdf", useDingbats = FALSE, width=2.5, height=1.3)
library(pheatmap)
pheatmap(MP_celltype_avg2, scale="column", col=paletteContinuous("solarExtra"), cluster_rows=TRUE, fontsize_row=5, fontsize_col=5, cluster_cols = TRUE, legend = TRUE, border_color=NA)
dev.off()
```



# MP by clustering
```{r}
MP_celltype <- seu@meta.data[,c("MPsignatures_NN_res.0.5","MP1","MP2","MP3","MP4","MP5","MP6","MP7","MP8","MP9","MP10")]
```

```{r}
library(dplyr)
MP_celltype_avg <- MP_celltype %>%
    group_by(MPsignatures_NN_res.0.5) %>% 
    summarise_each(funs(mean))
```

```{r}
MP_celltype_avg2 <- MP_celltype_avg[,-1]
MP_celltype_avg2 <- as.data.frame(MP_celltype_avg2)
rownames(MP_celltype_avg2) <- MP_celltype_avg$MPsignatures_NN_res.0.5
MP_celltype_avg2
```

```{r}
pdf("./MP_NMF_NN_res.0.5_2.pdf", useDingbats = FALSE, width=2.5, height=2.5)
library(pheatmap)
pheatmap(MP_celltype_avg2, scale="column", col=viridis(10), cluster_rows=TRUE, fontsize_row=5, fontsize_col=5, cluster_cols = TRUE, legend = TRUE, border_color=NA)
dev.off()
```


```{r}
saveRDS(seu, "integrated.rds")
```

```{r}
saveRDS(geneNMF.metaprograms, "geneNMF.metaprograms.rds")
```

# FMC gene score
```{r}
rna.rnamarkers <- read.csv("/Users/jamrute/Library/CloudStorage/Box-Box/Macbook_Files/Grad_School/Primary_Projects/Atherosclerosis/Projects/CITEseq_Atlas/analysis/final_analysis/cell_types/smc_fib/DE_RNA_cell.state.csv")
rna.rnamarkers
```

```{r}
rna.rnamarkers <- filter(rna.rnamarkers, rna.rnamarkers$cluster == "CMC")
rna.rnamarkers <- filter(rna.rnamarkers, rna.rnamarkers$avg_log2FC > 0.58)
rna.rnamarkers
```

```{r}
x <- intersect(c("MGP","LUM","VCAN","F2R","OMD","LTBP2","FAP","FN1","COL1A2","CFH","PLXDC2","THBS2","ITGBL1","PRELP","FBLN2","PDFRA","DCN","MMP2","PDGFD,","FXYD5","POSTN","LAMA2","MEG3","COL3A1","TMSB10","CRTAC1","PCOLCE2","COL8A1"), rownames(xenium.obj))
```

```{r}
DefaultAssay(seu) <- "SCT"
seu <- AddModuleScore(seu, features = list(x), assay="SCT", name = "CMCz")
```

```{r}
SpatialFeaturePlot(object=seu, features = "MP7", images = "Visium_T1071") + scale_fill_gradientn(colors=viridis::inferno(256))
```
```{r}
saveRDS(seu, "integrated.rds")
```

```{r}
Idents(seu) <- "MPsignatures_NN_res.0.5"

SpatialDimPlot(seu, images = "Visium_T1170_LAD", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_T1170_LAD-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_T1186_RCA", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_T1186_RCA-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_T1171_LM", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_T1171_LM-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_T1099R", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_T1099R-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_T1077", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_T1077-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_T1163", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_T1163-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_T1183_RCA", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_T1183_RCA-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_T1153R", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_T1153R-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_T1161_RCA", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_T1161_RCA-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_T1190_RCA", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_T1190_RCA-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_T1079", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_T1079-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_LCA", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_LCA-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_D1118_LAD", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_D1118_LAD-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_T1071", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_T1071-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_T1111", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_T1111-MPsignatures_NN_res.0.5.png")

SpatialDimPlot(seu, images = "Visium_T1167_LAD", cols = paletteDiscrete(unique(seu$MPsignatures_NN_res.0.5), set = "stallion"))
ggsave("Visium_T1167_LAD-MPsignatures_NN_res.0.5.png")

```

```{r}
geneNMF.metaprograms <- readRDS("geneNMF.metaprograms.rds")
```

```{r}
MP1_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP1)
MP1_genes$MP <- "MP1"
colnames(MP1_genes) <- c("gene","MP")

MP2_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP2)
MP2_genes$MP <- "MP2"
colnames(MP2_genes) <- c("gene","MP")

MP3_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP3)
MP3_genes$MP <- "MP3"
colnames(MP3_genes) <- c("gene","MP")

MP4_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP4)
MP4_genes$MP <- "MP4"
colnames(MP4_genes) <- c("gene","MP")

MP5_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP5)
MP5_genes$MP <- "MP5"
colnames(MP5_genes) <- c("gene","MP")

MP6_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP6)
MP6_genes$MP <- "MP6"
colnames(MP6_genes) <- c("gene","MP")

MP7_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP7)
MP7_genes$MP <- "MP7"
colnames(MP7_genes) <- c("gene","MP")

MP8_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP8)
MP8_genes$MP <- "MP8"
colnames(MP8_genes) <- c("gene","MP")

MP9_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP9)
MP9_genes$MP <- "MP9"
colnames(MP9_genes) <- c("gene","MP")

MP10_genes <- data.frame(geneNMF.metaprograms$metaprograms.genes$MP10)
MP10_genes$MP <- "MP10"
colnames(MP10_genes) <- c("gene","MP")
```

```{r}
MP_genes <- bind_rows(MP1_genes, MP2_genes, MP3_genes, MP4_genes, MP5_genes, MP6_genes, MP7_genes, MP8_genes, MP9_genes, MP10_genes)
```

```{r}
write.csv(MP_genes, file ="./MP_genes.csv", quote = FALSE)
```

```{r}
DefaultAssay(seu) <- "SCT"
pdf("./MP_dotplot.pdf", useDingbats = FALSE, width=16, height=4)
DotPlot(seu, features = c("MP1","MP2","MP3","MP4"), group.by = "MPsignatures_NN_res.0.5", col.min=0, cols = c("lightgrey", "red")) + RotatedAxis()
dev.off()
```



```{r}
DefaultAssay(seu) <- 'SCT'
Idents(seu) <- "MPsignatures_NN_res.0.5"
rna.rnamarkers <- FindAllMarkers(seu, only.pos = TRUE, min.pct = 0.1, logfc.threshold = 0.1)
write.csv(rna.rnamarkers, file ="./DE_MPsignatures_NN_res.0.5.csv", quote = FALSE)
```

```{r}
rna.rnamarkers %>%
    group_by(cluster) %>%
    top_n(n = 5, wt = avg_log2FC) -> top10
```

```{r}
top10
```

```{r}
DefaultAssay(seu) <- "SCT"
pdf("./MP_dotplot.pdf", useDingbats = FALSE, width=16, height=4)
DotPlot(seu, features = unique(top10$gene), group.by = "MPsignatures_NN_res.0.5", col.min=0, cols = c("lightgrey", "red")) + RotatedAxis()
dev.off()
```

```{r}
seu <- readRDS("integrated.rds")
```

```{r}
x <- intersect(c("MGP","LUM","VCAN","F2R","OMD","LTBP2","FAP","FN1","COL1A2","CFH","PLXDC2","THBS2","ITGBL1","PRELP","FBLN2","PDFRA","DCN","MMP2","PDGFD,","FXYD5","POSTN","LAMA2","MEG3","COL3A1","TMSB10","CRTAC1","PCOLCE2","COL8A1"), rownames(seu))

x
```

```{r}
DefaultAssay(seu) <- "SCT"
seu <- AddModuleScore(seu, features = list(x), assay="SCT", name = "FAPModule")
```

```{r}
DotPlot(seu, features = x, group.by = "MPsignatures_NN_res.0.5") + RotatedAxis()
```
```{r}
avg <- AverageExpression(seu, assay = "SCT", group.by = "MPsignatures_NN_res.0.5", features = x)
```

```{r}
pdf("./FAPModule_NMF_NN_res.0.5_2.pdf", useDingbats = FALSE, width=2.5, height=2.5)
library(pheatmap)
pheatmap(avg$SCT, scale="row", col=paletteContinuous("solarExtra"), cluster_rows=TRUE, fontsize_row=5, fontsize_col=5, cluster_cols = TRUE, legend = TRUE, border_color=NA)
dev.off()
```

```{r}
# Load necessary libraries
library(UpSetR)
library(tidyverse)

# Load your data
df <- read.csv("MP_genes.csv", stringsAsFactors = FALSE)

# Step 1: Make binary matrix — 1 if gene present in MP
binary_matrix <- df %>%
  distinct() %>%
  mutate(present = 1) %>%
  tidyr::pivot_wider(names_from = MP, values_from = present, values_fill = list(present = 0))

# Step 2: Aggregate duplicates by taking max (i.e., presence = 1 if gene appears in multiple rows)
binary_matrix <- binary_matrix %>%
  dplyr::group_by(gene) %>%
  dplyr::summarise(across(everything(), max), .groups = "drop")
```

```{r}
# Step 3: Make UpSet plot
pdf("./MP_UpSet.pdf", width=6, height=5.5)
upset(as.data.frame(binary_matrix %>% select(-gene)),
      nsets = ncol(binary_matrix) - 1,
      nintersects = 40,
      order.by = "freq",
      sets.bar.color = "steelblue",
      main.bar.color = "black")
dev.off()
```

```{r}
FAP_module <- c("MGP","LUM","VCAN","F2R","OMD","LTBP2","FAP","FN1","COL1A2","CFH","PLXDC2","THBS2","ITGBL1","PRELP","FBLN2","PDFRA","DCN","MMP2","PDGFD,","FXYD5","POSTN","LAMA2","MEG3","COL3A1","TMSB10","CRTAC1","PCOLCE2","COL8A1")
```

```{r}
df_MP5 <- subset.data.frame(df, df$MP == "MP5")
df_MP7 <- subset.data.frame(df, df$MP == "MP7")
```

```{r}
intersect(df_MP5$gene, df_MP7$gene)
```

```{r}
# Load libraries
library(dplyr)
library(tidyr)
library(ggplot2)

# If plyr is loaded, detach it
if ("package:plyr" %in% search()) {
  detach("package:plyr", unload = TRUE)
}

# Step 1: Filter for FAP_module genes
overlap_df <- binary_matrix %>%
  filter(gene %in% FAP_module)

# Step 2: Make sure values are binary (0 or 1)
binary_overlap <- overlap_df %>%
  select(-gene) %>%
  mutate(across(everything(), ~ ifelse(. > 0, 1, 0)))

# Step 3: Summarize overlap counts
overlap_counts <- binary_overlap %>%
  summarise(across(everything(), sum)) %>%
  pivot_longer(cols = everything(), names_to = "MP", values_to = "OverlapCount") %>%
  arrange(desc(OverlapCount))

# Step 4: Plot
overlap_counts <- overlap_counts %>%
  filter(MP != "X")

pdf("./MP_FAPModuleOverlapp.pdf", width=3, height=3)
ggplot(overlap_counts, aes(x = reorder(MP, -OverlapCount), y = OverlapCount)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "FAP_module Gene Overlap with Each MP",
       x = "MP",
       y = "Overlapping Genes") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

dev.off()
```

