```{r}
library(dplyr)
library(Seurat)
library(patchwork)
library(sctransform)
library(ggplot2)
library(harmony)
library(ArchR)
library(ggsci)
```

###### Preprocessing Steps

# Load the dataset and create a Seurat Object
```{r}
ApoBInjected_dir <- './data/ApoBInjected/'
ApoBInjected.data <- Read10X(data.dir =ApoBInjected_dir)
ApoBInjected <- CreateSeuratObject(counts = ApoBInjected.data)
ApoBInjected$condition <- "ApoBInjected"

ApoBInjected_12W_dir <- './data/ApoBInjected_12W/'
ApoBInjected_12W.data <- Read10X(data.dir =ApoBInjected_12W_dir)
ApoBInjected_12W <- CreateSeuratObject(counts = ApoBInjected_12W.data)
ApoBInjected_12W$condition <- "ApoBInjected_12W"

HFDControl_dir <- './data/HFDControl/'
HFDControl.data <- Read10X(data.dir =HFDControl_dir)
HFDControl <- CreateSeuratObject(counts = HFDControl.data)
HFDControl$condition <- "HFDControl"

HFDControl_12W_dir <- './data/HFDControl_12W/'
HFDControl_12W.data <- Read10X(data.dir =HFDControl_12W_dir)
HFDControl_12W <- CreateSeuratObject(counts = HFDControl_12W.data)
HFDControl_12W$condition <- "HFDControl_12W"

sample <- merge(ApoBInjected, y = c(ApoBInjected_12W, HFDControl, HFDControl_12W))
```

# Look at the features
```{r}
sample[["percent.mt"]] <- PercentageFeatureSet(sample, pattern = "^mt-")
VlnPlot(sample, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size = 0, group.by = "condition")
```

```{r}
sample <- subset(sample, subset = nFeature_RNA > 200 & nFeature_RNA < 6000 & percent.mt < 10 & nCount_RNA < 35000)
```

```{r}
VlnPlot(sample, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, group.by = "condition")
```

# SCTransform and filtering
```{r}
DefaultAssay(sample) <- 'RNA'
sample <- SCTransform(sample, vars.to.regress = c("percent.mt", "nCount_RNA"), verbose = TRUE)
sample <- RunPCA(sample, features = VariableFeatures(object = sample), npcs=100, verbose=TRUE)
```

```{r}
sample <- RunHarmony(sample, c("condition"), reduction = "pca", reduction.save = "harmony", assay.use = "SCT")
sample <- RunUMAP(sample, reduction = "harmony", dims = 1:50)
sample <- FindNeighbors(sample, reduction = "harmony", dims = 1:50)
sample <- FindClusters(sample, graph.name = "SCT_snn", algorithm = 3, resolution = c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8), verbose = FALSE)
```

```{r}
DimPlot(sample, reduction = 'umap', label = TRUE, repel = TRUE, label.size = 2.5, group.by = "SCT_snn_res.0.2", cols = paletteDiscrete(unique(sample$SCT_snn_res.0.2), set = "stallion"))
```

# DGE
```{r}
Idents(sample) <- "SCT_snn_res.0.2"
DefaultAssay(sample) <- 'SCT'
rna.markers <- FindAllMarkers(sample, only.pos = TRUE, min.pct = 0.1, logfc.threshold = 0.25)
write.csv(rna.markers, file ="./DE_SCT_snn_res.0.2.csv", quote = FALSE)
```

```{r}
saveRDS(sample, "global.rds")
```

```{r}
Idents(sample) <- "SCT_snn_res.0.2"
sample$condition <- factor(sample$condition, levels = c("HFDControl","HFDControl_12W","ApoBInjected","ApoBInjected_12W"))
endothelium <- subset(sample, idents = c("6"))
stroma <- subset(sample, idents = c("0","1","2","3","5","7","8","9"))
myeloid <- subset(sample, idents = c("4"))
```

```{r}
DotPlot(stroma, features = c("Fap","Runx1","Sox9","Myh11"), group.by = "condition") + RotatedAxis()
DotPlot(stroma, features = c("Spp1","Lgals3"), group.by = "condition") + RotatedAxis()
```

```{r}
unique(myeloid$condition)
```


```{r}
Idents(myeloid) <- "condition"
myeloid2 <- subset(myeloid, idents = c("HFDControl_12W","ApoBInjected_12W"))
DefaultAssay(myeloid2) <- 'SCT'
rna.markers <- FindAllMarkers(myeloid2, min.pct = 0.1, logfc.threshold = 0.25, only.pos = TRUE)
write.csv(rna.markers, file ="./DE_myeloid_ApoBInjected_12W_vs_HFDControl_12W.csv", quote = FALSE)
```

```{r}
Idents(stroma) <- "condition"
stroma2 <- subset(stroma, idents = c("HFDControl_12W","ApoBInjected_12W"))
DefaultAssay(stroma2) <- 'SCT'
rna.markers <- FindAllMarkers(stroma2, min.pct = 0.1, logfc.threshold = 0.25, only.pos = TRUE)
write.csv(rna.markers, file ="./DE_stroma_ApoBInjected_12W_vs_HFDControl_12W.csv", quote = FALSE)
```

```{r}
saveRDS(sample, "global.rds")
```


```{r}
library(Seurat)
library(ggplot2)
library(patchwork)
library(ggpubr)
library(dplyr)
library(sctransform)
library(pheatmap)
library(Matrix)
library(RColorBrewer)
library(scales)
library(data.table)
library(stats)
library(ggsci)
library(ArchR)
library(biomaRt)

library(nichenetr)
library(tidyverse)
```

```{r}
ref <- readRDS("/Users/jamrute/Library/CloudStorage/Box-Box/Macbook_Files/Grad_School/Primary_Projects/Atherosclerosis/Projects/CITEseq_Atlas/analysis/final_analysis/cell_types/myeloid/final/myeloid_annotated.rds")
```

```{r}
mydata <- myeloid
mouse_rna_matrix <- mydata@assays[["RNA"]]@counts
rownames(mouse_rna_matrix) <- mouse_rna_matrix %>% rownames() %>% convert_mouse_to_human_symbols()
mouse_rna_matrix <- mouse_rna_matrix %>% .[!is.na(rownames(mouse_rna_matrix)), !is.na(colnames(mouse_rna_matrix))]
mouse_coronary_new <- CreateSeuratObject(counts = mouse_rna_matrix)
mouse_coronary_new <- AddMetaData(object = mouse_coronary_new, metadata = mydata@meta.data)
```

```{r}
DefaultAssay(mouse_coronary_new) <- "RNA"
DefaultAssay(ref) <- "RNA"
mouse_coronary_new <- subset(mouse_coronary_new, features = rownames(ref))
```

# Process the Mouse DataSet
```{r}
DefaultAssay(mouse_coronary_new) <- "RNA"
mouse_coronary_new <- NormalizeData(mouse_coronary_new)
mouse_coronary_new <- FindVariableFeatures(mouse_coronary_new, selection.method = "vst", nfeatures = 3000)
mouse_coronary_new <- ScaleData(mouse_coronary_new)
```

```{r}
mouse_coronary_new <- SCTransform(mouse_coronary_new, verbose = FALSE)
```

```{r}
saveRDS(mouse_coronary_new, "mouse_to_human_normalized.rds")
```

# Reference Mapping
```{r}
human_coronary <- ref
```

```{r}
human_coronary <- RunSPCA(human_coronary, graph = "RNA_snn")
```

```{r}
DefaultAssay(human_coronary) <- "SCT"
DefaultAssay(mouse_coronary_new) <- "SCT"

anchors <- FindTransferAnchors(
  reference = human_coronary,
  query = mouse_coronary_new,
  normalization.method = "SCT",
  reference.reduction = "spca",
  dims = 1:50,
  reference.assay = "SCT"
)
```

```{r}
mouse_coronary_new <- MapQuery(
  anchorset = anchors,
  query = mouse_coronary_new,
  reference = human_coronary,
  refdata = list(
    celltype = "cell.state",
    predicted_ADT = "ADT"),
  reference.reduction = "spca", 
  reduction.model = "rna.umap"
)
```

```{r}
DimPlot(mouse_coronary_new, reduction = "ref.umap", group.by = "predicted.celltype", label.size = 4,
        cols = paletteDiscrete(unique(human_coronary$cell.state), set = "stallion"), label = FALSE, split.by = "condition")
```

```{r}
ggplot(mouse_coronary_new@meta.data, aes(x=condition, fill=predicted.celltype)) + geom_bar(position = "fill") + theme_linedraw() + theme(axis.text.x = element_text(angle = 90)) +  scale_fill_manual(values=paletteDiscrete(unique(human_coronary$cell.state), set = "stallion")) + theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()) 
```
































```{r}
Idents(mouse_coronary_new) <- "condition"
DefaultAssay(mouse_coronary_new) <- 'RNA'
rna.markers <- FindAllMarkers(mouse_coronary_new, only.pos = TRUE, min.pct = 0.1, logfc.threshold = 0.25)
write.csv(rna.markers, file ="./DE_condition.csv", quote = FALSE)
```

```{r}
prog <- rna.markers %>% filter(rna.markers$cluster == "progression")
reg <- rna.markers %>% filter(rna.markers$cluster == "regression")
```

```{r}
prog %>%
    group_by(cluster) %>%
    top_n(n = 200, wt = avg_log2FC) -> prog_top10

reg %>%
    group_by(cluster) %>%
    top_n(n = 200, wt = avg_log2FC) -> reg_top10
```

```{r}
DefaultAssay(ref) <- "RNA"
expdata <- GetAssayData(ref)
Pop1 <- prog_top10$gene
pops<-list(Pop1)
#Z-Scores
z_scores<-NULL

for (i in 1:length(pops)) {
genes <- pops[[i]]
zz <- which(tolower(rownames(expdata)) %in% tolower(genes))
av <- numeric(ncol(expdata))

geneExp <- as.matrix(expdata[zz, ])
geneExp <- t(scale(t(geneExp)))
geneExp[is.nan(geneExp)] <- 0
z_scores <- rbind(z_scores,(av + colSums(geneExp) / length(zz)))
}
ref@meta.data$progression <- z_scores[1,]
FeaturePlot(object=ref, features = "progression",reduction = 'rna.umap') + scale_color_gradientn(colors=c("blue","turquoise2","yellow","red","red4"), oob=scales::squish, limits=c(0,0.5))
```

```{r}
DefaultAssay(ref) <- "RNA"
expdata <- GetAssayData(ref)
Pop1 <- reg_top10$gene
pops<-list(Pop1)
#Z-Scores
z_scores<-NULL

for (i in 1:length(pops)) {
genes <- pops[[i]]
zz <- which(tolower(rownames(expdata)) %in% tolower(genes))
av <- numeric(ncol(expdata))

geneExp <- as.matrix(expdata[zz, ])
geneExp <- t(scale(t(geneExp)))
geneExp[is.nan(geneExp)] <- 0
z_scores <- rbind(z_scores,(av + colSums(geneExp) / length(zz)))
}
ref@meta.data$regression <- z_scores[1,]
FeaturePlot(object=ref, features = "regression",reduction = 'rna.umap') + scale_color_gradientn(colors=c("blue","turquoise2","yellow","red","red4"), oob=scales::squish, limits=c(0,1))
```

```{r}
ref$reg_to_prog <- (ref$regression + (min(ref$regression) * -1))/(ref$progression + (min(ref$progression) * -1))
```

```{r}
ref$reg_minus_prog <- ref$regression - ref$progression
```

```{r}
VlnPlot(ref, features = "reg_to_prog", group.by = "cell.state", sort = TRUE, pt.size = 0, log = TRUE)
```

```{r}
VlnPlot(ref, features = "reg_minus_prog", group.by = "cell.state", sort = TRUE, pt.size = 0, log = TRUE)
```


```{r}
DefaultAssay(myeloid) <- "SCT"
expdata <- GetAssayData(myeloid)
Pop1 <- c("Spp1","Cd74","Ftl1","Ctsd","Ctsb","H2-Aa","Apoe","Timp1","Laptm5","Fth1","C1qc","Psap")
pops<-list(Pop1)
#Z-Scores
z_scores<-NULL

for (i in 1:length(pops)) {
genes <- pops[[i]]
zz <- which(tolower(rownames(expdata)) %in% tolower(genes))
av <- numeric(ncol(expdata))

geneExp <- as.matrix(expdata[zz, ])
geneExp <- t(scale(t(geneExp)))
geneExp[is.nan(geneExp)] <- 0
z_scores <- rbind(z_scores,(av + colSums(geneExp) / length(zz)))
}
myeloid@meta.data$FoamNiche <- z_scores[1,]
```


```{r}
pdf("./FoamNiche_mouse_regression.pdf", useDingbats = FALSE, width=4.3, height=2.8)
DotPlot(myeloid, features = "FoamNiche", group.by = "condition") + RotatedAxis()
dev.off()
```





# Plot niche 5 signature in CITE-seq data
```{r}
DefaultAssay(sample) <- "SCT"
expdata <- GetAssayData(sample)
Pop1 <- c("SPP1","CD74","FTL","CTSD","CTSB","HLA-DRA","APOE","TIMP1","LAPTM5","FTH1","C1QC","PSAP")
pops<-list(Pop1)
#Z-Scores
z_scores<-NULL

for (i in 1:length(pops)) {
genes <- pops[[i]]
zz <- which(tolower(rownames(expdata)) %in% tolower(genes))
av <- numeric(ncol(expdata))

geneExp <- as.matrix(expdata[zz, ])
geneExp <- t(scale(t(geneExp)))
geneExp[is.nan(geneExp)] <- 0
z_scores <- rbind(z_scores,(av + colSums(geneExp) / length(zz)))
}
sample@meta.data$Niche5<-z_scores[1,]
```
